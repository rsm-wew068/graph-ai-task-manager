name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install uv
          uv sync --frozen
      
      - name: Lint
        run: |
          pip install flake8
          # Use .flake8 configuration file for lenient linting
          flake8 . --count --show-source --statistics
      
      - name: Test imports
        run: |
          python -c "from utils.email_parser import parse_uploaded_file_with_filters_safe"
          python -c "from utils.embedding import embed_dataframe"
          python -c "from utils.graph_writer import write_tasks_to_neo4j"
          python -c "from utils.graphrag import GraphRAG"
          python -c "from utils.langchain_neo4j_agent import answer_with_neo4j_agent"
          python -c "from utils.langgraph_nodes import get_llm"
          python -c "from utils.langgraph_dag import run_extraction_pipeline"
          python -c "from utils.chainqa_graph_agent import chainqa_graph_search"
      
      - name: Test FastAPI backend
        run: |
          # Test that FastAPI app can be imported
          python -c "from utils.api import app"
          echo "FastAPI app imports successfully"
      
      - name: Test Streamlit app
        run: |
          # Test that Streamlit app can be imported
          python -c "import streamlit; import app"
          echo "Streamlit app imports successfully"
